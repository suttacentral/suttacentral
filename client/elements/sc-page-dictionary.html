<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../styles/sc-dict-styles.html">
<link rel="import" href="../styles/sc-scrollbar-style.html">

<dom-module id="sc-page-dictionary">
  <template>
    <style include="sc-dict-styles sc-scrollbar-style">
      .dictionary-results-container, .related-terms {
        @apply --sc-sans-font;
        padding: var(--sc-size-xxl) 0;
      }

      .dictionary-results-main {
        max-width: 720px;
        margin: 0 auto;
      }

      .dictionary-results-head {
        display: flex;
        justify-content: space-between;
        padding: 0;
      }

      h1 {
        @apply --paper-font-display1;
        color: var(--sc-secondary-text-color);
        display: inline-block;
        margin: 0 0 0 -2px;
      }

      .dictionary-results-term {
        @apply --sc-serif-font;
        font-weight: bold;
        color: var(--sc-primary-accent-color);
      }

      .terms-button {
        color: var(--sc-disabled-text-color);
      }

      .related-terms {
        margin: 0 var(--sc-size-md) var(--sc-size-xl) 0;
        text-align: left;
      }

      .related-terms ul {
        margin: var(--sc-size-sm) 0 0 0;
        display: block;
        list-style: none;
        padding: 0;
      }

      .related-terms h3 {
        @apply --paper-font-body1;
        color: var(--sc-secondary-text-color);
        margin: var(--sc-size-md-larger) 0 0 var(--sc-size-md);
        font-weight: bold;
      }

      .dictionary-entries {
        padding: 0;
      }

      .related-terms li {
        @apply --paper-font-body1;
      }

      .related-terms a {
        color: var(--sc-primary-accent-color);
        padding: var(--sc-size-xs) 0 var(--sc-size-xs) var(--sc-size-md);
        margin: var(--sc-size-xs) 0;
        text-decoration: none;
        display: inline-block;
      }

      .related-terms em {
        color: var(--sc-primary-text-color);
      }

      .dictionary-source {
        @apply --paper-font-body1;
        color: var(--sc-secondary-text-color);
        margin: var(--sc-size-sm) 0 var(--sc-size-md);
        font-weight: bold;
        @apply --sc-serif-font;
      }

      .dictionary-book-entry {
        border-bottom: var(--sc-border);
      }

      #drawer {
        --app-drawer-content-container: {
          overflow-y: scroll;
        }
      }

      .sc-tooltip {
        --paper-tooltip-opacity: 0.98;
        --paper-tooltip-background: var(--sc-paper-tooltip-color);
        --paper-tooltip: {
          @apply --sc-sans-font;
          @apply --sc-skolar-font-size-xs;
          line-height: var(--sc-size-md);
          padding: var(--sc-size-sm) var(--sc-size-md);
          text-shadow: 0 0 var(--sc-secondary-background-color);
          white-space: normal;
        }
      }

      .selected-terms-item {
        background: linear-gradient(to right, var(--sc-primary-color) 4px, var(--sc-primary-color-transparent) 4px);
      }

      .selected-terms-item > a {
          color: var(--sc-primary-color);
      }
    </style>

    <iron-ajax
        id="ajax"
        handle-as="json"
        last-response="{{dictionaryReturns}}"
        on-response="_didRespond"></iron-ajax>

    <iron-ajax
        id="adjacent_ajax"
        handle-as="json"
        last-response="{{adjacentReturns}}"
        on-response="_adjacentLoaded"></iron-ajax>

    <iron-ajax
        id="glossary_ajax"
        handle-as="json"
        last-response="{{glossaryReturns}}"
        on-response="_glossaryLoaded"></iron-ajax>

    <iron-meta id="meta"></iron-meta>

    <div class="dictionary-results-container">
      <main class="dictionary-results-main">
        <div class="dictionary-results-head">
          <h1><span class="dictionary-results-description">Definitions for</span> <span
              class="dictionary-results-term">[[dictionaryWord]]</span></h1>
          <span class="terms-button">
            <paper-icon-button icon="menu" id="menu_icon" on-tap="_toggleDrawer"></paper-icon-button>
            <paper-tooltip for="menu_icon" class="sc-tooltip" fit-to-visible-bounds>Related Items</paper-tooltip>
          </span>
        </div>
        <div class="dictionary-entries">
          <template is="dom-repeat" items="[[dictionaryResults]]" as="result">
            <div class="dictionary-book-entry">
              <div class="dictionary-source">[[_getDictionaryTitle(result.dictname)]]</div>
              <div class="dictionary-text" inner-h-t-m-l="[[result.text]]"></div>
            </div>
          </template>
        </div>

        <app-drawer id="drawer" align="right" class="sc-scrollbar" swipe-open>
          <div class="related-terms sc-scrollbar">
            <h3>Adjacent Terms</h3>
            <ul class="near-terms">
              <template is="dom-repeat" items="[[dictonaryAdjacent]]">
                <li class$="[[_calculateClass(item)]]">
                  <a href="/define/[[item]]">[[item]]</a>
                  <!-- <template is="dom-if" if="[[item.trans]]"><em>([[item.trans]])</em></template> -->
                </li>
              </template>
            </ul>
            <h3>Similar Spelling</h3>
            <ul class="fuzzy-terms">
              <template is="dom-repeat" items="[[dictionarySimilar]]">
                <li class$="[[_calculateClass(item)]]">
                  <a href="/define/[[item]]">[[item]]</a>
<!--               <template is="dom-if" if="[[item.trans]]"><em>([[item.trans]])</em></template>
 -->            </li>
              </template>
            </ul>
          </div>
        </app-drawer>

      </main>
    </div>

  </template>

  <script>
      class SCPageDictionary extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-page-dictionary';
          }

          static get properties() {
              return {
                  dictionaryResults: Array,
                  dictionaryReturns: Array,
                  glossaryReturns: Array,
                  adjacentReturns: Array,
                  dictionaryWord: {
                      type: String,
                      observer: '_loadNewResult'
                  },
                  dictionaryTitles: {
                      type: Object,
                      value: {
                          'ncped': 'New Concise Pali English Dictionary',
                          'cped': 'Concise Pali English Dictionary',
                          'dhammika': 'Nature and the Environment in Early Buddhism by S. Dhammika',
                          'dppn': 'Pali Proper Names',
                          'pts': 'PTS Pali English Dictionary'
                      }
                  },
                  // The below two arrays are just temporary mockups.
                  dictonaryAdjacent: {
                      type: Array,
                      value: ['dhamita','dhamitv훮','dhameti','dhamenta','dhamesi',
                      'dhamma','dhammakath훮','dhammakathika','dhammakamma','dhammakaraka']
                  },
                  dictionarySimilar: {
                      type: Array,
                      value: ['dhamma','dhamm훮','adhamma','dhamman','dhamm카','ghamma',
                      'dhama','damma','uddhamma','opamma']
                  }
              }
          }

          _computeUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/dictionary_full/${this.dictionaryWord}`;
          }

          _loadNewResult() {
              this.$.ajax.url = this._computeUrl();
              return this.$.ajax.generateRequest();
          }

          _didRespond() {
              let dictsUsed = {};
              let finalResults = [];
              for (let key in this.dictionaryTitles) {
                  dictsUsed = this._sortDictionaryResults(key);
                  if (dictsUsed) {
                      finalResults.push(dictsUsed);
                  }
              }
              this.dictionaryResults = finalResults;
              this._loadAdjacent();
              // this._loadGlossary();
          }

          _sortDictionaryResults(dictionary) {
              for (let item in this.dictionaryReturns) {
                  if (this.dictionaryReturns[item].dictname == dictionary) {
                    return this.dictionaryReturns[item];
                  }
              }
          } 

          _getDictionaryTitle(dictname) {
              return this.dictionaryTitles[dictname];
          }

          // Adding Adjacent Terms
          _computeAdjacentUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/adjacent`;
          }

          _loadAdjacent() {
              this.$.adjacent_ajax.url = this._computeAdjacentUrl();
              return this.$.adjacent_ajax.generateRequest();
          }

          _adjacentLoaded() {
              console.log("loaded Adjacent");
              console.log(this.AdjacentReturns);
          }

          _calculateClass(item) {
              return (item === this.dictionaryWord) ? 'selected-terms-item' : '';
          }

          // Adding glossary results to related items drawer
          _computeGlossaryUrl() {
              return `${this.$.meta.byKey('API_ROOT')}/glossary`;
          }

          _loadGlossary() {
              this.$.glossary_ajax.url = this._computeGlossaryUrl();
              return this.$.glossary_ajax.generateRequest();
          }

          _glossaryLoaded() {
              console.log("loaded Glossary");
              console.log(this._getGlossaryDescription("dhamma"));
              console.log(this.glossaryReturns);
          }

          _getGlossaryDescription(glossword) {
              console.log(this.glossaryReturns(glossword));
              return this.glossaryReturns(glossword);
          }

          // toggles the drawer on the right to show the related/similar items.
          _toggleDrawer() {
              this.$.drawer.toggle();
          }

      }

      customElements.define(SCPageDictionary.is, SCPageDictionary);
  </script>
</dom-module>
