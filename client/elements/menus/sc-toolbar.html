<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/communication-icons.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/bower_components/iron-location/iron-location.html">

<link rel="import" href="/elements/menus/sc-more-menu.html">

<!--
Base toolbar that appears on the top right in the header of every page. This toolbar is called from the page-selector.

Issues:
  - The paper badge that appears only on text-pages next to the link to the Discourse forum now only shows
    the number 20 but it should show the correct search results instead.
  - The paper badge has the annoying habit of occasionally disappearing for no apparent reason.
    It seems that it calculates the position too far to the right so as to go off the screen.
    `this.shadowRoot.querySelector('paper-badge').updatePosition();` does not seem to work to rectify this. It seems to also
    show this behavior here: https://github.com/PolymerElements/paper-badge/pull/12 and briefly show in
    the correct position but then disappear to the right.
-->
<dom-module id="sc-toolbar">
  <template>
    <style is="custom-style">
      .white-icon {
        color: white;
      }

      .toolbar-paper-button {
        --paper-menu-button-dropdown: {
          max-width: 100%;
        };
      }

      .toolbar-input {
        --paper-input-container: {
          padding: 0;
        };
        --paper-input-container-color: white;
        --paper-input-container-focus-color: white;
        --paper-input-container-label: {
          color: white;
          opacity: 0.6;
        };
        --paper-input-container-input: {
          color: white;
        };
        display: inline-block;
        vertical-align: text-bottom;
      }

      #close_button {
        display: none;
      }

      #search_input {
        width: 0;
        transition: width .2s cubic-bezier(.4, 0, .2, 1);
      }

      .hidebutton {
        display: none;
      }

      .toolbar-link {
        text-decoration: none;
      }

      .search-open #discoursebutton, .search-open > #more_vert_button {
        display: none;
      }
    </style>

    <iron-location path="{{path}}" query="{{query}}"></iron-location>

    <div id="tools_menu">
      <!-- Search field. iron-a11y-keys fires when the enter-key is pressed-->
      <iron-a11y-keys target="search_input" keys="enter" on-keys-pressed="startSearch"></iron-a11y-keys>
      <paper-icon-button icon="search" class="white-icon" on-tap="openSearch"></paper-icon-button>
      <paper-input class="toolbar-input" label="Search" no-label-float id="search_input"></paper-input>
      <paper-icon-button icon="close" class="white-icon" id="close_button" on-tap="closeSearch"></paper-icon-button>

      <!-- Link to Discourse.suttacentral.net. On sutta-pages with a search for that resp. sutta. -->
      <a class="toolbar-link" tabindex="-1" target="_blank">
        <paper-icon-button id="discoursebutton" class="white-icon" icon="communication:forum"></paper-icon-button>
      </a>

      <!-- Menu for more options like language and other static pages -->
      <paper-menu-button class="toolbar-paper-button" horizontal-align="right" ignore-select id="more_vert_button">
        <paper-icon-button icon="more-vert" class="white-icon" slot="dropdown-trigger" alt="menu"></paper-icon-button>
        <paper-listbox slot="dropdown-content" tabindex="0" id="paper_listbox">
          <sc-more-menu></sc-more-menu>
        </paper-listbox>
      </paper-menu-button>
    </div>
  </template>

  <script>
      class SCToolbar extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-toolbar'
          }

          static get properties() {
              return {
                  path: String,
                  query: String
              }
          }

          ready() {
            super.ready();
            this.$.paper_listbox.addEventListener('iron-select', (e) => {console.log(e);})
          }

          // When looking-glass icon is clicked, determines if the searchbox is already open and if so, starts the search.
          // If not, it opens the search box and moves other elements out of the way depending on the width of the screen.
          openSearch() {
              if (this.$.search_input.classList.contains('opened')) {
                  this.startSearch();
              } else {
                  this.$.search_input.classList.add('opened');
                  this.$.search_input.focus();
                  this.$.close_button.style.display = 'inline-block';
                  this.$.search_input.value = '';
                  let searchSize = 500;
                  if (window.innerWidth < 1040) {
                      Polymer.dom(this.root.host.offsetParent).querySelector('#toolbar_title_box')
                          .setAttribute('style', 'visibility:hidden')
                  }
                  let searchWidth;
                  if (window.innerWidth > 840) {
                      searchWidth = window.innerWidth - searchSize;
                  } else if (window.innerWidth > 480) {
                      searchWidth = window.innerWidth - (searchSize - 210);
                  } else {
                      this.$.tools_menu.classList.add('search-open');
                      searchWidth = window.innerWidth - (searchSize - 320);
                  }
                  if (searchWidth > 360) {
                      searchWidth = 360
                  }
                  this.shadowRoot.querySelector('.opened').style.width = searchWidth;
              }
          }

          // Closes the searchbox and resets original values.
          closeSearch() {
              if (this.$.search_input.classList.contains('opened')) {
                  this.$.search_input.classList.remove('opened');
                  this.$.search_input.removeAttribute('style', 'width');
                  this.$.close_button.style.display = 'none';
                  this.$.tools_menu.classList.remove('search-open');
                  Polymer.dom(this.root.host.offsetParent).querySelector('#toolbar_title_box')
                      .removeAttribute('style', 'display');
              }
          }

          // Initiates the search function.
          startSearch() {
              const searchQuery = this.$.search_input.value;
              this.set('path', '/search');
              this.set('query', `query=${searchQuery}`);
          }

      }

      customElements.define(SCToolbar.is, SCToolbar);
  </script>
</dom-module>