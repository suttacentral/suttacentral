<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="/bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="/bower_components/app-layout/app-drawer/app-drawer.html">

<link rel="import" href="/elements/paper-tree-sc/paper-tree.html">
<link rel="import" href="/elements/page-selector.html">

<!-- Imports for the sutta text dialogs: -->
<link rel="import" href="/bower_components/isw-dialog/isw-dialog.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="/bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<!--
  The navdrawer is the first element that is called and it loads the navigation-drawer (`app-drawer`) and populates
  this with the menu-tree through `paper-tree-sc` (**paper-tree.html** and **paper-tree-node.html**).

  Issue:
    For the grayed out backdrop, the sutta text dialogs must be placed outside the text-view itself because of a
    missing functionality in webcomponents. At the moment, they can't be moved to a separate element as well.
    TODO: Move the text dialogs back to <sc-text-options> once the following issue is fixed:
    https://github.com/PolymerElements/paper-dialog/issues/152
    https://github.com/PolymerElements/paper-dialog-behavior/issues/78
    https://github.com/PolymerElements/paper-dialog/issues/44#issuecomment-172013206
-->
<dom-module id="sc-navdrawer">
  <template>
    <style>
      :host {
        background-color: grey;
        --app-drawer-width: 300px;
      }

      :host([is-wide]) {
        --app-drawer-width: 360px;
      }

      .sc-paper-tree {
        @apply --sc-sans-font;
      }

      .nav-list-container {
        padding-top: 1em;
      }

      .nav-wheel-icon {
        @apply --sc-serif-font;
        color: white;
        margin-top: 5px;
        margin-left: var(--size-md);
        font-size: 45px;
        display: inline-block;
        vertical-align: sub;
      }

      .nav-home-title {
        @apply --sc-serif-font;
        @apply --sc-mixed-small-caps;
        @apply --sc-skolar-font-size-static-subtitle;
        background-color: var(--sc-secondary-text-color);
        padding-bottom: var(--size-xs);
        color: white;
        font-weight: normal;
        margin: 0;
        white-space: nowrap;
        height: 60px;
        line-height: 1.4;
      }

      .nav-home-link {
        color: white;
        text-decoration: none;
      }

      .nav-home-link:focus {
        outline: none;
      }

      .nav-drawer-box {
        @apply --shadow-elevation-16dp;
        overflow: auto;
        height: 100%;
      }

      .paper-spinner {
        --paper-spinner-color: var(--sc-primary-color);
      }

      .icon-middle {
        position: absolute;
        margin: 0;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .network-error-icon {
        width: 64px;
        height: 64px;
      }

      /* styles for the text dialogs: */

      .dialog {
        left: var(--app-drawer-width);
        white-space: initial;
        max-width: 630px;
        position: fixed;
        top: 50px;
        margin: 5% auto;
        right: 0;
      }

      @media screen and (max-width: 840px) {
        .dialog {
          left: 0;
        }
      }

      .dialog paper-icon-button {
        color: var(--disabled-text-color);
      }

      .dialog > paper-dialog-scrollable {
        margin-top: var(--size-lg);
      }

      .dialog-header {
        @apply --paper-font-title;
        @apply --sc-sans-font;
        @apply --sc-skolar-font-size-xxl;
        padding-bottom: var(--size-lg);
        color: white;
        margin: 0;
      }

      .green-bg {
        background-color: var(--sc-primary-accent-color);
      }

    </style>

    <iron-meta id="meta" key="API_ROOT" value="{{_getApiUrl()}}"></iron-meta>

    <iron-media-query query="(min-width: 992px)" query-matches="{{wideScreen}}"></iron-media-query>

    <iron-ajax
        auto
        url="[[_getMenuUrl()]]"
        handle-as="json"
        loading="{{loading}}"
        last-error="{{error}}"
        last-response="{{navList}}"
    ></iron-ajax>

    <app-drawer-layout fullbleed responsive-width="840px">

      <app-drawer slot="drawer">
        <div class="nav-drawer-box">
          <div class="nav-home-title">
            <a class="nav-home-link" href="/">
              <div class="nav-wheel-icon">â˜¸</div>
              <span class="nav-home-title-text">&nbsp;SuttaCentral</span>
            </a>
          </div>
          <div id="container" class="nav-list-container">
            <template is="dom-if" if="{{_shouldShowLoadingIndicator(loading, error)}}">
              <div class="loading-indicator">
                <paper-spinner-lite class="paper-spinner icon-middle" active="{{loading}}"></paper-spinner-lite>
              </div>
            </template>

            <template is="dom-if" if="{{error}}">
              <iron-icon class="network-error-icon icon-middle" title="Network error"
                         src="img/nonetwork.svg"></iron-icon>
            </template>

            <template is="dom-repeat" items="{{navList}}">
              <paper-tree class="sc-paper-tree" data='{{item}}' is-wide="[[wideScreen]]"></paper-tree>
            </template>
          </div>
        </div>
      </app-drawer>

      <page-selector></page-selector>

    </app-drawer-layout>

    <!--
      The dialogs for the sutta text view:
    -->

    <isw-dialog id="settings_dialog" name="settings_dialog" class="dialog" with-backdrop="true"
                entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="buttons green-bg">
        <paper-icon-button icon="close" dialog-confirm></paper-icon-button>
      </div>
      <h2 class="dialog-header green-bg">Text settings</h2>
      <paper-dialog-scrollable>
        <settings-menu></settings-menu>
      </paper-dialog-scrollable>
    </isw-dialog>

    <isw-dialog id="info_dialog" name="info_dialog" class="dialog" with-backdrop="true" data="{{infoDialogMetaArea}}"
                entry-animation="fade-in-animation" exit-animation="fade-out-animation">
      <div class="buttons green-bg">
        <paper-icon-button icon="close" dialog-confirm></paper-icon-button>
      </div>
      <h2 class="dialog-header green-bg">Publication details</h2>
      <paper-dialog-scrollable>
        <div class="dialogue-section">
          <div inner-h-t-m-l="[[infoDialogMetaArea]]">
          </div>
        </div>
      </paper-dialog-scrollable>
    </isw-dialog>

  </template>

  <script>
      class SCNavdrawer extends ReduxMixin(Polymer.Element) {
          static get is() {
              return 'sc-navdrawer';
          }

          static get properties() {
              return {
                  inputLanguage: {
                      type: String,
                      notify: true
                  },
                  category: {
                      type: String,
                      notify: true
                  },
                  wideScreen: {
                      type: Boolean,
                      observer: '_screenWidthChanged'
                  },
                  navList: {
                      type: Array,
                      observer: '_parseNavList'
                  },
                  infoDialogMetaArea: {
                      type: String,
                      statePath: 'suttaMetaText'
                  }
              }
          }

          ready() {
              super.ready();
              // triggered when the menu button in the toolbar is pressed when the app-drawer is not visible
              this.addEventListener('toggleDrawer', (e) => this._toggleDrawer(e));
              // Lock scroll for the text dialogs:
              this._addScrollLockListeners();
          }

          // Set the width of the nav drawer
          _screenWidthChanged() {
              const hostAttributes = this.$.container.__dataHost.attributes;
              if (this.wideScreen) {
                  hostAttributes.setNamedItem(document.createAttribute('is-wide'));
              }
              else if (hostAttributes.getNamedItem('is-wide')) {
                  hostAttributes.removeNamedItem('is-wide');
              }
          }

          // Open the first two tiers of the sidebar menu and add icons
          _parseNavList() {
              this.navList[0].open = true;
              if (!this.navList[0].children) {
                  return;
              }
              this.navList[0].children.forEach((item) => {
                  item.open = true;
                  item.icon = 'trending-flat';
                  if (!item.children) {
                      return;
                  }
                  item.children.forEach((subItem) => {
                      subItem.icon = 'turned-in';
                  })
              });
          }

          // opens the app-drawer when it is not visible.
          _toggleDrawer(event) {
              return this.shadowRoot.querySelector('app-drawer').setAttribute('opened', event.detail.togdraw);
          }

          _getMenuUrl() {
              return `${this._getApiUrl()}/menu`;
          }

          // Locks scroll on text dialogs:
          _addScrollLockListeners() {
              let scrollLockListener = (dialog) => {
                  if (dialog.opened) {
                      Polymer.IronDropdownScrollManager.pushScrollLock(dialog);
                  } else {
                      Polymer.IronDropdownScrollManager.removeScrollLock(dialog);
                  }
              };
              let settingsDialog = this.$.settings_dialog;
              let infoDialog = this.$.info_dialog;
              settingsDialog.addEventListener('opened-changed', () => { scrollLockListener(settingsDialog) });
              infoDialog.addEventListener('opened-changed', () => { scrollLockListener(infoDialog) });
          }

          _shouldShowLoadingIndicator(loading, error) {
              return !!(loading && !error);
          }

          _getApiUrl() {
              let currentUrl = window.location;
              return `${currentUrl.protocol}//${currentUrl.host}/api`;
          }
      }

      customElements.define(SCNavdrawer.is, SCNavdrawer);
  </script>
</dom-module>